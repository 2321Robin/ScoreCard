# 打牌记分器

线下打牌记分网页，移动端友好，含自动平衡、撤销重做、CSV 导入导出、目标局数自动导出等功能，数据默认保存在浏览器。

## 功能概览
- 玩家管理：默认 4 人（玩家 A/B/C/D），2-8 人可增删改，自动同步表格列；支持重命名。
- 录入与编辑：在“新增一局”填写分值（可输入或下拉选择），点“自动平衡”用空白或最后一人补齐；已记录行需点“编辑”后保存/取消，整局可删除。
- 分值范围：默认 -10~-1，可自定义上下限，刷新下拉列表。
- 平衡校验：每局总和必须为 0；失衡行红底提示，可一键平衡。
- 撤销/重做：最多 50 步；清空前需确认。
- 汇总与折线：实时总分卡片；支持展开/收起“分数变化折线图”查看累计走势。
- 模式切换与麻将统计：积分模式（手动录入分值）与麻将模式（选择胡牌者、记录暗杠/点杠，自动按规则结算，规则可调整）；麻将模式的对局记录和总分展示胡/杠描述与累计。
- 跨会话总览：表格支持排序、导出当前/全部会话、筛选特定会话；可切换指标查看每位玩家的总分、赢局数、胡数、杠数；折线图跟随筛选与指标展示逐会话走势。
- CSV 导入导出：导出含时间戳、玩家列、每局分值、逐局累计、总分行，UTF-8 BOM 兼容 Excel，文件名 `scores-YYYYMMDD-HHMM.csv`；可导入此前导出的 CSV 覆盖当前数据。
- 目标局数：可预设总局数，达标后自动导出一次并询问是否继续，可重设或清空目标。
- 持久化与无障碍：localStorage 自动保存；提供 skip link、aria 标签、键盘可操作；浅色柔和主题（surface #f7f6f1 / panel #ffffff / accent #7fb37a / text #2f3128 / muted #6f7664 / danger #e25b5b）。

## 使用说明
1) 新增一局：在“新增一局”为每位玩家输入或下拉选择分值，必要时点“自动平衡”，再点“添加本局”。
2) 编辑/删除：在对局表中点“编辑”进入可改状态，完成后“保存”或“取消”；可删除整局。
3) 撤销/重做：顶部按钮回溯或恢复最近 50 步操作；“清空”需确认。
4) 导出/导入：点“导出 CSV”下载，点“导入 CSV”选择此前导出的文件即可恢复。
5) 目标局数：顶部输入目标后点“设定”；达标会自动导出并提示是否继续，继续可输入新目标。
6) 自定义分值范围：在新增区域输入上下限并点“更新范围”。
7) 跨会话总览：在“指标”下拉选择总分/赢局/胡数/杠数，按需切换“范围”到自定义并勾选会话；表格与折线图会随选择更新。

## 手机访问（无备案）
- Cloudflare Tunnel：（可能不稳定）
  1) 安装：`winget install cloudflare.cloudflared`
  2) 启动项目：
  ```bash
  npm run dev -- --host 127.0.0.1 --port 5173
  ```
  3) 另开终端：
  ```bash
  cloudflared tunnel --url http://127.0.0.1:5173
  ```
  4) 使用输出的 `https://xxxx.trycloudflare.com` 在手机访问（重启会换链接）
  5) 若遇 1033/无法访问，重启 cloudflared；如网络对 QUIC 不友好，追加 `--protocol h2mux`

## 开发与运行
```bash
npm install
npm run dev     # 开发
npm run build   # 生产构建
npm run preview # 本地预览构建
npm run test:run
```

## 技术栈
- Vite + React + Tailwind CSS
- 测试：Vitest + Testing Library
- 状态：组件内 useState + useMemo；localStorage 持久化

## 代码结构
- [src/App.jsx](src/App.jsx)：主壳组件，负责会话切换、状态管理、导入导出、汇总与导航。
- 组件：
  - [src/components/PageToc.jsx](src/components/PageToc.jsx)：页面内目录（跳转到玩家/对局/新增/总分/图表/跨会话）。
  - [src/components/PlayersSection.jsx](src/components/PlayersSection.jsx)：玩家增删改区块。
  - [src/components/RoundsTable.jsx](src/components/RoundsTable.jsx)：对局列表与编辑入口（支持麻将规则、买码、跟庄）。
  - [src/components/NewRoundSection.jsx](src/components/NewRoundSection.jsx)：新增一局（积分/麻将/特殊局，规则调整，自动平衡）。
  - [src/components/TotalsSection.jsx](src/components/TotalsSection.jsx)：总分与胡/杠/赢局统计。
  - [src/components/ScoreChartSection.jsx](src/components/ScoreChartSection.jsx)：分数变化折线图与导出。
  - [src/components/CrossSessionOverview.jsx](src/components/CrossSessionOverview.jsx)：跨会话表格与折线总览。
- 工具库：
  - [src/lib/constants.js](src/lib/constants.js)：全局常量与默认配置（玩家上限、存储键、麻将默认规则等）。
  - [src/lib/helpers.js](src/lib/helpers.js)：基础工具函数（整数规范、数组补全、时间戳格式化、文件名解析）。
  - [src/lib/mahjong.js](src/lib/mahjong.js)：麻将相关纯函数（杠草稿生成、胡/杠计分、胜者推导）。
  - [src/lib/mahjongAdjustments.js](src/lib/mahjongAdjustments.js)：麻将模式附加调整（买码、跟庄）。
  - [src/lib/csv.js](src/lib/csv.js)：CSV 解析与转义辅助。
  - [src/lib/sessions.js](src/lib/sessions.js)：会话模型创建、初始化加载、会话级 CSV 解析。

## 待办
- 已完成：
  - 扩展为多会话数据模型，支持会话切换/新建/删除/重命名，旧版数据自动生成默认会话，撤销/重做按会话独立历史。
  - 录入/编辑/撤销/目标局数/导入导出均作用于当前会话，切换时重置编辑与输入状态。
  - 跨会话总览表格：展示会话总分、局数、时间，支持排序；新增“导出当前/全部会话”按钮。
  - 跨会话折线图：按会话顺序展示玩家累计总分，可折叠。
  - CSV 导入/导出 v2：含会话元数据，向后兼容 v1（单会话导入自动包裹为一个会话）。
  - 测试补充：覆盖默认渲染、v1 兼容加载、多会话总览渲染。
  - 导入选择：导入多会话文件时可选择仅导入首个会话至当前会话，或导入全部会话覆盖。
  - 模式切换完成：默认积分模式；麻将模式下选择胡牌者、记录暗杠/点杠（可指定点谁），按可配置规则自动结算分数，仍保持零和且不影响原有功能。
  - “跨会话总览”添加可选总览哪几次局，默认全部。
  - 对于麻将模式，希望在对局记录和总分出能看到累计的杠数和胡数。
  - 对于两种模式，在总览时可选查看赢得局数
  - 麻将模式在编辑对局记录时也做相应的修改
  - 积分模式在总分栏用小字加上赢的局数
  - 切换模式改为仅修改当前会话，不影响其他会话
  - 导出的csv添加模式区别，不同模式导出的csv有所不同
  - 麻将模式在添加一局时考虑一局中一个人可能多次杠的情况
  - 导出的csv中，积分模式加上累计赢数，麻将模式加上累计胡数和累计杠数
  - 添加每一局的时间戳，导出 CSV 包含时间戳（前端不显示）
  - 麻将模式添加特殊局选项，特殊的一局可以自定义每个人的分数，比如跟庄的情况就与现有的不同
  - 特殊局再提交时可以自定义备注信息，取消下拉选择
  - 特殊局不要局号，它相当于一局的补充，它和它的下一局正常局视为同一局，这样折线图就比较合适
  - 顶部的菜单栏有点太长了，在手机上这个问题尤为严重，几乎占了半个屏幕，能否做成顶部菜单栏通过点击按钮展开收起
  - 加上备案号：赣ICP备2026002780号（公网备案暂无）
  - 网站名字改为“打牌记分器”
  - 麻将模式新增“买码”玩法（0-4，默认 0；买码为 x：胡的人 +3x，其余每人 -x）
  - 麻将模式：新增庄家标签，庄家默认是上一局的赢家。也可手动选择庄家。
  - 麻将模式：新增一局处加上跟庄选项。跟庄有两种类型，第一种是庄家给其它三人各出一分；第二种是庄家给某个人出三分。
  - 双模式：折线图可导出、放大查看。
  - 跨对话的列表可折叠，可隐藏跨会话表格。
  - 电脑上菜单栏可折叠，默认桌面展开。
  - App.jsx 拆分为多个子组件并添加页面目录，结构更清晰，便于导航。
- 未完成
  - 暂无（可按需补充）。